<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.gym.mapper.xml.FacilityQueryMapper">

  <resultMap id="FacilityMap" type="com.gym.domain.facility.Facility">
    <id     column="facility_id"         property="facilityId"/>
    <result column="facility_name"       property="facilityName"/>
    <result column="member_id"           property="memberId"/>
    <result column="instructor_id"       property="instructorId"/>  <!-- ⚠️ [251008] 담당자ID 컬럼 추가 -->
    <result column="facility_phone"      property="facilityPhone"/>
    <result column="facility_content"    property="facilityContent"/>
    <result column="facility_image_path" property="facilityImagePath"/>
    <result column="facility_person_max" property="facilityPersonMax"/>
    <result column="facility_person_min" property="facilityPersonMin"/>
    <result column="facility_use"        property="facilityUse"/>
    <result column="facility_reg_date"   property="facilityRegDate"/>
    <result column="facility_mod_date"   property="facilityModDate"/>
    <result column="facility_open_time"  property="facilityOpenTime"/>
    <result column="facility_close_time" property="facilityCloseTime"/>
    <result column="facility_money"      property="facilityMoney"/>
    <result column="facility_type"   property="facilityType"/> <!-- ⚠️ [251001] 카테고리 매핑 추가 -->
  </resultMap>

  <!-- 목록/검색 -->
  <select id="selectFacilities" resultMap="FacilityMap">
  <!--*[251107] <![CDATA[ ]> : 페이징 할 떄, 논리 안정화하려는 목적으로 필요함 -->
  <!-- RNUM으로 할당해서 줄어들였음 -->
  <![CDATA[
    SELECT *
    FROM (
        SELECT
            ROWNUM AS RNUM,
            A.*
        FROM (
              SELECT
              F.FACILITY_ID,
              F.FACILITY_NAME,
              F.MEMBER_ID,
              F.INSTRUCTOR_ID,
              F.FACILITY_PHONE,
              F.FACILITY_CONTENT,
              F.FACILITY_IMAGE_PATH,
              F.FACILITY_PERSON_MAX,
              F.FACILITY_PERSON_MIN,
              F.FACILITY_USE,
              F.FACILITY_REG_DATE,
              F.FACILITY_MOD_DATE,
              TO_CHAR(F.FACILITY_OPEN_TIME,'HH24:MI') AS facility_open_time,
              TO_CHAR(F.FACILITY_CLOSE_TIME,'HH24:MI') AS facility_close_time,
              F.FACILITY_MONEY,
              F.FACILITY_TYPE
            FROM GYM.FACILITY_TBL F  
            WHERE 1=1
  			]]>
  			
            <if test="name != null and name != ''">
              AND F.FACILITY_NAME LIKE '%' || #{name} || '%'
            </if>
            <if test="facilityUse != null">
              AND F.FACILITY_USE = (CASE WHEN #{facilityUse} THEN 'Y' ELSE 'N' END)
            </if>
            <if test="type != null and type != ''">
              AND F.FACILITY_TYPE = #{type} 
            </if>
            
            <choose>
              <when test="sort != null and sort != ''">
                <choose>
                  <when test="sort == 'name,asc' or sort == 'name'">
                    ORDER BY F.FACILITY_NAME ASC
                  </when>
                  <when test="sort == 'name,desc'">
                    ORDER BY F.FACILITY_NAME DESC
                  </when>
                  <when test="sort == 'regdate,asc' or sort == 'regdate'">
                    ORDER BY F.FACILITY_REG_DATE ASC
                  </when>
                  <when test="sort == 'regdate,desc'">
                    ORDER BY F.FACILITY_REG_DATE DESC
                  </when>
                  <otherwise>
                    ORDER BY F.FACILITY_ID
                  </otherwise>
                </choose>
              </when>
              <otherwise>
                ORDER BY F.FACILITY_ID
              </otherwise>
            </choose>
            
	   <![CDATA[
	    ) A
	    WHERE ROWNUM <= (#{page} + 1) * #{size}
	    )
	    WHERE RNUM > #{page} * #{size}
		]]>
		<!-- WHERE ROWNUM <= (#{page} + 1) * #{size} 는 ROWNUM <= 종료 행 (page=0, size=10 일 때 ROWNUM <= 10)
			 WHERE RNUM > #{page} * #{size}는 RNUM > 시작 행 (page=0, size=10 일 때 RNUM > 0 -> 1페이지 시작 논리 반영) -->
  </select>

  <select id="countFacilities" resultType="long">
    SELECT COUNT(1)
    FROM facility_tbl f
    <where>
      <if test="name != null and name != ''">
        AND f.facility_name LIKE '%' || #{name} || '%'
      </if>
      <if test="facilityUse != null">
        AND f.facility_use = (CASE WHEN #{facilityUse} THEN 'Y' ELSE 'N' END)
      </if>
      <!-- ⚠️ [251001] 카테고리 필터 -->
      <if test="type != null and type != ''">
        AND f.facility_type = #{type} 
      </if>
    </where>
  </select>
  
  <!-- [251008] CMS시설 등록, 담당강사 조회(admin_type 필터 포함) -->
  <resultMap id="MemberMap" type="com.gym.domain.member.Member">
    <id     column="member_id"    property="memberId"/>
    <result column="member_name"  property="memberName"/>
    <result column="member_email" property="memberEmail"/>
    <result column="admin_type"   property="adminType"/>
  </resultMap>
  <select id="selectCmsMembers" resultMap="MemberMap">
	SELECT member_id, member_name, member_email, admin_type
	FROM member_tbl
	WHERE member_role = 'admin'         <!-- 관리자 권한 -->
	AND admin_type = '강사'             <!-- 강사만 조회 -->
	<if test="name != null and name != ''">
		AND member_name LIKE '%' || #{name} || '%'
	</if>
	ORDER BY member_id DESC
  </select>

</mapper>
