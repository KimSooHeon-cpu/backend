<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.gym.mapper.xml.PostMapper">

    <resultMap id="PostResultMap" type="com.gym.domain.post.PostResponse">
    <id property="postId" column="post_id"/>
    <result property="boardId" column="board_id"/>
    <result property="boardPostNo" column="board_post_no"/>
    <result property="postTitle" column="post_title"/>
    <result property="postContent" column="post_content"/>
    <result property="memberId" column="member_id"/>
    <result property="memberName" column="member_name"/>
    <result property="postRegDate" column="post_reg_date"/>
    <result property="postViewCount" column="post_view_count"/>
    <result property="postNotice" column="post_notice"/>
    <result property="postSecret" column="post_secret"/>
    <result property="postType" column="post_type"/>
    <result property="postFilePath" column="post_file_path" jdbcType="VARCHAR"/>
  </resultMap>

    <insert id="insertPost"
          parameterType="com.gym.domain.post.Post"
          keyProperty="postId">
    INSERT INTO post_tbl (
      post_id, board_id, post_title, post_content, member_id,
      post_reg_date, post_mod_date, post_view_count,
      post_notice, post_secret, post_type, post_file_path
    ) VALUES (
      **post_seq.NEXTVAL**,       #{boardId}, #{postTitle}, #{postContent}, #{memberId},
      SYSDATE, NULL, 0,
      <choose><when test="postNotice"> 'Y' </when><otherwise> 'N' </otherwise></choose>,
      <choose><when test="postSecret"> 'Y' </when><otherwise> 'N' </otherwise></choose>,
      #{postType},
      #{postFilePath, jdbcType=VARCHAR}
    )
        <selectKey keyProperty="postId" resultType="long" order="AFTER">
      SELECT post_seq.CURRVAL FROM dual
    </selectKey>
  </insert>

    <update id="updatePost" parameterType="com.gym.domain.post.PostResponse">
    UPDATE post_tbl SET
      post_title = #{postTitle},
      post_content = #{postContent},
      post_mod_date = SYSDATE,
      post_notice =
        <choose>
          <when test="postNotice"> 'Y' </when>           <otherwise> 'N' </otherwise>
        </choose>,
      post_secret =
        <choose>
          <when test="postSecret"> 'Y' </when>           <otherwise> 'N' </otherwise>
        </choose>,
      post_type = #{postType, jdbcType=VARCHAR},
      post_file_path = #{postFilePath, jdbcType=VARCHAR}
    WHERE post_id = #{postId}
  </update>

    <select id="selectPostsByBoard" resultMap="PostResultMap"
	parameterType="map">
  <![CDATA[
    SELECT *
    FROM (
        SELECT
            ROWNUM AS RNUM,
            A.*
        FROM (
            SELECT
              p.post_id, p.board_id, p.board_post_no, p.post_title, p.post_content, p.member_id,
              m.member_name, p.post_reg_date, p.post_view_count, p.post_notice, p.post_secret, p.post_type,
              p.post_file_path
            FROM post_tbl p LEFT JOIN member_tbl m ON p.member_id = m.member_id 
            WHERE p.board_id = #{boardId}
  ]]>
	<if test="keyword != null and keyword.trim() != ''">
		AND (p.post_title LIKE '%' || #{keyword} || '%' OR p.post_content LIKE
		'%' || #{keyword} || '%')
	</if>
	<if test="notice != null">
		AND p.post_notice = <![CDATA[ #{notice} ? 'Y' : 'N' ]]>
	</if>
  <![CDATA[
            ORDER BY
              CASE WHEN p.post_notice = 'Y' THEN 0 ELSE 1 END,
              p.board_post_no DESC
        ) A
        WHERE ROWNUM <= #{offset} + #{limit}
    )
    WHERE RNUM > #{offset}
  ]]>
</select>

  </mapper>
